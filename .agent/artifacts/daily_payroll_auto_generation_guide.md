# Daily Payroll Auto-Generation Integration Guide

## Overview
This guide explains how to integrate automatic daily payroll generation when an employee checks out.

## Option 1: Integration in AttendanceController (Recommended)

### Step 1: Update the checkout logic in AttendanceController

Find the method where checkout happens (likely `markAttendance` or `markMyAttendance`) and add the auto-generation call:

```php
// In AttendanceController.php

use App\Http\Controllers\Hr\PayrollController;
use App\Services\PayrollCalculationService;

public function markAttendance(Request $request)
{
    // ... existing checkout logic ...
    
    // After successful checkout:
    if ($attendance->clock_out && $employee) {
        // Auto-generate daily payroll if applicable
        $this->autoGenerateDailyPayroll($employee, $attendance);
    }
    
    return response()->json([
        'success' => 'Attendance marked successfully.',
    ]);
}

/**
 * Auto-generate daily payroll when employee checks out
 */
private function autoGenerateDailyPayroll($employee, $attendance)
{
    try {
        $payrollController = new PayrollController(new PayrollCalculationService());
        $payrollController->autoGenerateDaily($employee, $attendance);
    } catch (\Exception $e) {
        // Log error but don't fail the checkout process
        \Log::error('Failed to auto-generate daily payroll: ' . $e->getMessage());
    }
}
```

## Option 2: Using Laravel Events (More Elegant)

### Step 1: Create an Event

```bash
php artisan make:event AttendanceCheckedOut
```

### Step 2: Define the Event

```php
<?php

namespace App\Events;

use App\Models\Hr\Attendance;
use App\Models\Hr\Employee;
use Illuminate\Foundation\Events\Dispatchable;
use Illuminate\Queue\SerializesModels;

class AttendanceCheckedOut
{
    use Dispatchable, SerializesModels;

    public $employee;
    public $attendance;

    public function __construct(Employee $employee, Attendance $attendance)
    {
        $this->employee = $employee;
        $this->attendance = $attendance;
    }
}
```

### Step 3: Create a Listener

```bash
php artisan make:listener GenerateDailyPayroll --event=AttendanceCheckedOut
```

### Step 4: Define the Listener

```php
<?php

namespace App\Listeners;

use App\Events\AttendanceCheckedOut;
use App\Services\PayrollCalculationService;
use App\Models\Hr\Payroll;
use App\Models\Hr\PayrollDetail;
use Carbon\Carbon;
use Illuminate\Support\Facades\DB;

class GenerateDailyPayroll
{
    protected $payrollService;

    public function __construct(PayrollCalculationService $payrollService)
    {
        $this->payrollService = $payrollService;
    }

    public function handle(AttendanceCheckedOut $event): void
    {
        $employee = $event->employee;
        $attendance = $event->attendance;

        // Check if employee uses daily wages
        if (!$employee->salaryStructure || !$employee->salaryStructure->use_daily_wages) {
            return;
        }

        // Check if payroll already exists for this date
        $month = Carbon::parse($attendance->date)->format('Y-m');
        $exists = Payroll::where('employee_id', $employee->id)
            ->where('month', $month)
            ->where('payroll_type', 'daily')
            ->whereDate('created_at', $attendance->date)
            ->exists();

        if ($exists) {
            return;
        }

        try {
            DB::beginTransaction();

            $payrollData = $this->payrollService->calculateDailyPayroll($employee, $attendance);

            $payroll = Payroll::create(array_merge(
                ['employee_id' => $employee->id],
                array_except($payrollData, ['allowance_details', 'deduction_details', 'new_pending_deductions'])
            ));

            $this->payrollService->savePayrollDetails(
                $payroll,
                $payrollData['allowance_details'] ?? [],
                $payrollData['deduction_details'] ?? []
            );

            $this->payrollService->updatePendingDeductions(
                $employee,
                $payrollData['new_pending_deductions'] ?? 0
            );

            DB::commit();
            
            \Log::info("Daily payroll auto-generated for employee {$employee->full_name} (ID: {$employee->id})");
        } catch (\Exception $e) {
            DB::rollBack();
            \Log::error('Auto-generate daily payroll failed: ' . $e->getMessage());
        }
    }
}
```

### Step 5: Register the Event and Listener

In `app/Providers/EventServiceProvider.php`:

```php
<?php

namespace App\Providers;

use App\Events\AttendanceCheckedOut;
use App\Listeners\GenerateDailyPayroll;
use Illuminate\Foundation\Support\Providers\EventServiceProvider as ServiceProvider;

class EventServiceProvider extends ServiceProvider
{
    protected $listen = [
        AttendanceCheckedOut::class => [
            GenerateDailyPayroll::class,
        ],
    ];
}
```

### Step 6: Dispatch the Event in AttendanceController

```php
use App\Events\AttendanceCheckedOut;

public function markAttendance(Request $request)
{
    // ... existing checkout logic ...
    
    // After successful checkout:
    if ($attendance->clock_out && $employee) {
        event(new AttendanceCheckedOut($employee, $attendance));
    }
    
    return response()->json([
        'success' => 'Attendance marked successfully.',
    ]);
}
```

## Testing the Integration

### Manual Test
1. Ensure an employee has:
   - Salary structure with `use_daily_wages = true`
   - Daily wage amount set
   - Attendance deduction policy configured

2. Mark attendance with checkout for that employee

3. Check the `hr_payrolls` table:
   ```sql
   SELECT * FROM hr_payrolls 
   WHERE employee_id = [EMPLOYEE_ID] 
   AND payroll_type = 'daily' 
   ORDER BY created_at DESC;
   ```

4. Verify:
   - Payroll record created
   - `auto_generated = 1`
   - `status = 'generated'`
   - Deductions calculated correctly
   - Pending deductions updated if applicable

### Test Carry-Forward Logic
1. Create scenario with heavy deductions (> daily wage)
2. Checkout employee
3. Verify `employee.pending_deductions` is updated
4. Checkout same employee next day
5. Verify carried deduction is applied

## Troubleshooting

### Payroll not generating automatically
- Check if employee has `use_daily_wages = true`
- Check if attendance has `clock_out` time
- Check logs: `storage/logs/laravel.log`
- Verify event is dispatched (if using events)

### Deductions not calculating correctly
- Verify attendance deduction policy in salary structure
- Check `late_minutes` and `early_leave_minutes` in attendance
- Review PayrollCalculationService logic

### Carry-forward not working
- Check `carry_forward_deductions` in salary structure
- Verify `pending_deductions` column exists in employees table
- Check migration was run

## Disable Auto-Generation (if needed)

If you want to temporarily disable auto-generation:

1. **Option 1**: Comment out the event dispatch or method call
2. **Option 2**: Add a setting in HR settings to enable/disable
3. **Option 3**: Add a feature flag

## Production Recommendations

1. **Queue the listener**: Make it implement `ShouldQueue` for better performance
2. **Add retry logic**: In case of temporary failures
3. **Send notifications**: Alert HR when payroll is auto-generated
4. **Add logging**: Track all auto-generation events for audit

Example with Queue:

```php
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Bus\Queueable;

class GenerateDailyPayroll implements ShouldQueue
{
    use Queueable;
    
    public $tries = 3;
    public $timeout = 120;
    
    // ... existing code ...
}
```

---

**Recommendation**: Use **Option 2 (Events)** for production - it's cleaner, more maintainable, and easily testable.
